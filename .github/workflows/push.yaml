name: Push
run-name: ${{ github.ref_name }} push run üöÄ
on:
  push:
    branches:
      - master
      - main
      - "release/**"
    tags:
      - "*"
permissions:
  contents: write
jobs:
  check-format:
    name: Check Formatting üîç
    if: github.ref_name == 'master' || github.ref_name == 'main'
    uses: ./.github/workflows/check-format.yaml
    permissions:
      contents: read

  build-project:
    name: Build Project üß±
    uses: ./.github/workflows/build-project.yaml
    secrets: inherit
    permissions:
      contents: read

  create-release:
    name: Create Release üõ´
    if: github.ref_type == 'tag'
    runs-on: ubuntu-24.04
    needs: build-project
    defaults:
      run:
        shell: bash
    steps:
      - name: Check Release Tag ‚òëÔ∏è
        id: check
        run: |
          : Check Release Tag ‚òëÔ∏è
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi
          shopt -s extglob

          case "${GITHUB_REF_NAME}" in
            +([0-9]).+([0-9]).+([0-9]) )
              echo 'validTag=true' >> $GITHUB_OUTPUT
              echo 'prerelease=false' >> $GITHUB_OUTPUT
              echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
              ;;
            +([0-9]).+([0-9]).+([0-9])-@(beta|rc)*([0-9]) )
              echo 'validTag=true' >> $GITHUB_OUTPUT
              echo 'prerelease=true' >> $GITHUB_OUTPUT
              echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
              ;;
            *) echo 'validTag=false' >> $GITHUB_OUTPUT ;;
          esac

      - name: Download Build Artifacts üì•
        uses: actions/download-artifact@v4
        if: fromJSON(steps.check.outputs.validTag)
        id: download

      - name: Rename Files üè∑Ô∏è
        if: fromJSON(steps.check.outputs.validTag)
        run: |
          : Rename Files üè∑Ô∏è
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi
          shopt -s extglob
          shopt -s nullglob

          root_dir="$(pwd)"
          commit_hash="${GITHUB_SHA:0:9}"

          variants=(
            'windows-x64;zip|exe'
            'windows-x64-portable;zip|exe'
            'windows-x64-installer;zip|exe'
            'macos-universal;tar.xz|pkg'
            'ubuntu-24.04-x86_64;tar.xz|deb|ddeb'
            'sources;tar.xz'
          )

          for variant_data in "${variants[@]}"; do
            IFS=';' read -r variant suffix <<< "${variant_data}"

            candidates=(*-${variant}-${commit_hash}/@(*|*-dbgsym).@(${suffix}))

            for candidate in "${candidates[@]}"; do
              mv "${candidate}" "${root_dir}"
            done
          done

      - name: Generate Checksums ü™™
        if: fromJSON(steps.check.outputs.validTag)
        run: |
          : Generate Checksums ü™™
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi
          shopt -s extglob

          echo "### Checksums" > ${{ github.workspace }}/CHECKSUMS.txt
          for file in ${{ github.workspace }}/@(*.exe|*.deb|*.ddeb|*.pkg|*.tar.xz|*.zip); do
            echo "    ${file##*/}: $(sha256sum "${file}" | cut -d " " -f 1)" >> ${{ github.workspace }}/CHECKSUMS.txt
          done

      - name: Create Release üõ´
        if: fromJSON(steps.check.outputs.validTag)
        id: create_release
        uses: softprops/action-gh-release@9d7c94cfd0a1f3ed45544c887983e9fa900f0564
        with:
          draft: true
          prerelease: ${{ fromJSON(steps.check.outputs.prerelease) }}
          tag_name: ${{ steps.check.outputs.version }}
          name: ${{ needs.build-project.outputs.pluginName }} ${{ steps.check.outputs.version }}
          body_path: ${{ github.workspace }}/CHECKSUMS.txt
          files: |
            ${{ github.workspace }}/*.exe
            ${{ github.workspace }}/*.zip
            ${{ github.workspace }}/*.pkg
            ${{ github.workspace }}/*.deb
            ${{ github.workspace }}/*.ddeb
            ${{ github.workspace }}/*.tar.xz

  deploy:
    name: Deploy to strih.lan üöÄ
    if: github.ref_type == 'branch'
    needs: build-project
    runs-on: [self-hosted, linux, deployer]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          pattern: "distroav-*-windows-x64-*"
          merge-multiple: false

      - name: Stop OBS
        run: |
          ssh strih.lan 'taskkill /IM obs64.exe /F' 2>/dev/null || true
          sleep 3

      - name: Deploy plugin files
        run: |
          ARTIFACT_DIR=$(ls -d distroav-*-windows-x64-*/ 2>/dev/null | grep -v portable | grep -v installer | head -1)
          if [ -z "$ARTIFACT_DIR" ]; then
            echo "FAIL: No artifact directory found"
            ls -la
            exit 1
          fi
          echo "Using artifact directory: $ARTIFACT_DIR"

          cd "$ARTIFACT_DIR"
          ZIP_FILE=$(ls *.zip 2>/dev/null | head -1)
          if [ -z "$ZIP_FILE" ]; then
            echo "FAIL: No ZIP file found in $ARTIFACT_DIR"
            ls -la
            exit 1
          fi
          echo "Extracting: $ZIP_FILE"
          unzip -o "$ZIP_FILE" -d extracted/

          echo "=== Extracted contents ==="
          find extracted/ -type f

          # Deploy DLL to legacy plugin path
          echo "Deploying distroav.dll..."
          scp extracted/distroav/bin/64bit/distroav.dll \
            'strih.lan:C:\Program Files\obs-studio\obs-plugins\64bit\distroav.dll'

          # Deploy data/locale files
          echo "Deploying locale files..."
          ssh strih.lan 'if not exist "C:\ProgramData\obs-studio\plugins\distroav\data\locale" mkdir "C:\ProgramData\obs-studio\plugins\distroav\data\locale"' 2>/dev/null || true
          scp -r extracted/distroav/data/locale/* \
            'strih.lan:C:\ProgramData\obs-studio\plugins\distroav\data\locale\'

          echo "Deployment complete"

      - name: Start OBS
        run: |
          ssh strih.lan 'schtasks /Run /TN "StartOBS"'
          echo "Waiting 12s for OBS startup and plugin initialization..."
          sleep 12

      - name: Verify deployment
        run: |
          echo "=== Checking OBS process ==="
          ssh strih.lan 'tasklist /FI "IMAGENAME eq obs64.exe"' | grep -q obs64.exe \
            || { echo "FAIL: OBS not running"; exit 1; }
          echo "OBS is running"

          echo "=== Checking plugin load ==="
          ssh strih.lan 'powershell -Command "
            \$log = Get-ChildItem \"$env:APPDATA\\obs-studio\\logs\\*.txt\" |
              Sort-Object LastWriteTime -Descending | Select-Object -First 1;
            Get-Content \$log.FullName | Select-String \"\\[distroav\\]\" | Select-Object -Last 5
          "'

      - name: SYNC log regression test
        run: |
          chmod +x .github/scripts/sync-log-regression-test.sh
          DEPLOY_HOST=strih.lan .github/scripts/sync-log-regression-test.sh

      - name: Cleanup
        if: always()
        run: rm -rf distroav-*/
